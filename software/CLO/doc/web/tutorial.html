<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <style type="text/css">@import url('clops.css');</style>
  <style type="text/css">@import url('prettify.css');</style>
  <script type="text/javascript" src="prettify.js"></script>
  <title>CLOPS tutorial</title>
</head>
<body onload="prettyPrint()">

<div class="title">CLOPS tutorial</div>

<p>I assume you have already read and followed the <a
href="install.html">installation instructions</a> for your
operating system. 
(TODO: Add overview, after the rest is written.)
</p>

<p>Please note that the examples below are <i>not</i> meant to
illustrate good style but rather to show many features in not
much space.</p>

<h1>Basic usage</h1>

<h2>A first example</h2>

<p>The <tt>wc</tt> tool computes statistics of a text, such as
the word count. Take a (short) look at its man page:</p>

<pre class="cmdline">man wc</pre>

<p>Create a fresh directory. All the commands in this tutorial
are written under the assumption that the current directory is
this fresh directory. Create a subdirectory <tt>src</tt> and in
it create a file <tt>wc.clops</tt> with the content: </p>

<pre class="prettyprint">
NAME::
  Wc

ARGS::
  Bytes: {"-c", "--bytes"} // option name, followed by aliases
  Chars: {"-m", "--chars"}
  Words: {"-w", "--words"}
  Lines: {"-l", "--lines"}
  LineLength: {"-L", "--max-line-length"}
  FilesFrom: {"--files0-from"}: {file}  // "file" is the option type
  Help: {"--help"}         /* the default type is "boolean" */
  Ver: {"--version"}
  Files: {}: {file-list}: [between="", allowMultiple="false"]

FORMAT::
  (Option | Files)*;  // this is a regular expression

WHERE::
  Option:   // shorthand to make the FORMAT easier to read
    Bytes OR Chars OR Words OR Lines OR LineLength OR
    FilesFrom OR Help OR Ver;
</pre>

<table class="gotcha">
<tr><td><img src="attention.png" alt="!"/></td><td>
The <i>properties</i> <tt>between</tt> and <tt>allowMultiple</tt>
will be explained in the <a href="#dashdash">Dealing with --</a> section.
</td></tr></table>

<p>Create a subdirectory <tt>generated</tt> under <tt>src</tt>.
Generate the parser with:</p>

<pre class="cmdline">
clops -i src/wc.clops -o src/generated -p generated
</pre>

<p>You should see three files in <tt>src/generated</tt>,
each containing a class. (The option <tt>-p</tt> is followed
by a package name.) We'll place <tt>Main.java</tt> under
<tt>src</tt>.</p>

<pre class="prettyprint">
import java.io.File;
import generated.WcParser;
import generated.WcOptionsInterface;

public class Main {
  public static void main(String[] args) throws Exception {
    WcParser parser = new WcParser();
    if (!parser.parse(args)) {
      System.out.println("Usage: java Main [OPTIONS] file...");
      System.exit(1);
    }
    WcOptionsInterface opt = parser.getOptionStore();
    if (opt.isWordsSet()) 
      System.out.println("I should print a word count.");
    if (opt.isBytesSet()) 
      System.out.println("I should print a byte count.");
    for (File f : opt.getFiles()) checkFile(f);
  }

  public static void checkFile(File f) {
    System.out.print("The file " + f.getPath());
    if (f.exists())
      System.out.println(" exists.");
    else
      System.out.println(" does not exist.");
  }
}
</pre>

<p>(TODO: Mention that you can generate a <tt>Main</tt> for testing
somewhere in the advanced section.)</p>

<p>Create a subdirectory <tt>classes</tt>. To compile, say:</p>

<pre class="cmdline">
javac -cp CLOPSPATH/clops-runtime.jar\
  -sourcepath src -d classes src/Main.java src/generated/*
</pre>

<p>On UNIX, replace <tt>CLOPSPATH</tt> by <tt>$CLOPSPATH</tt>. On
Windows, replace <tt>CLOPSPATH</tt> by <tt>%CLOPSPATH%</tt> and
slash&nbsp;(<tt>/</tt>) by backslash&nbsp;(<tt>\</tt>).</p>

<table class="gotcha">
<tr><td><img src="attention.png" alt="!"/></td><td>
Errors during compilation might be caused by
an incorrect CLOPS file. The code generation phase currently only
stops on the most obviously wrong CLOPS input.
</td></tr></table>

<p>You can now run your program with:</p>

<pre class="cmdline">
java -cp classes:CLOPSPATH/clops-runtime.jar Main ARGUMENTS
</pre>

<p>Try to replace <tt>ARGUMENTS</tt> with various values and see
what happens. In particular, try <tt>&quot;--files0-from=.&quot;</tt>,
<tt>&quot;--files0-from&nbsp;.&quot;</tt>, and only
<tt>&quot;--files0-from&quot;</tt>.</p>

<p>Congratulations: You have now finished the first part of the
tutorial and you saw how to use CLOPS instead of a hand-written
parser.</p>

<h2>Integrating with ANT</h2>

<p>The commands in the previous section are a little long but
hopefully you use a good build system that can handle the dirty
details for you. In this section you'll see how ANT can help.
Start by creating a directory <tt>jars</tt>. Populate it with all
the jar files in CLOPSPATH. Now create <tt>build.xml</tt>:</p>

<pre class="prettyprint">
&lt;project name="Wc" default="compile" basedir="."&gt;
  &lt;target name="compile" description="do everything"&gt;
    &lt;java fork="yes" dir="." jar="jars/clops.jar"&gt;
      &lt;arg value="src/wc.clops"/&gt;
      &lt;arg value="-o=src/generated"/&gt;
      &lt;arg value="-p=generated"/&gt;
    &lt;/java&gt;
    &lt;javac destdir="classes" srcdir="src" 
           classpath="jars/clops-runtime.jar" debug="yes"/&gt;
    &lt;jar destfile="jars/wc.jar" basedir="classes"&gt;
      &lt;manifest&gt;
        &lt;attribute name="Main-Class" value="Main"/&gt;
        &lt;attribute name="Class-Path" value="clops-runtime.jar"/&gt;
      &lt;/manifest&gt;
    &lt;/jar&gt;
  &lt;/target&gt;
&lt;/project&gt;
</pre>

<p>There are two differences from a usual ANT file:</p>

<ol>
<li>Before invoking the compiler using the <tt>javac</tt> task
  we invoke CLOPS to generate some files.</li>
<li>The <tt>clops-runtime.jar</tt> is added to the classpath
  of the generated jar.</li>
</ol>

<p>You are now ready to use CLOPS. If you run into problems check
the <a href="faq.html">FAQ</a> and, if that doesn't help, send us
an email. (TODO: mailing list address.)</p>

<h1>Advanced features</h1>

<h2><a name="dashdash"/>Dealing with <tt>--</tt></h2>

<p>The <tt>wc</tt> command line implementation above is
<i>almost</i> OK. One problem is that it doesn't allow the user
to examine a file whose name is &quot;<tt>-w</tt>&quot; (or any
other name that conflicts with an option). The usual convention
to handle such situations is to use a special option (<tt>--</tt>)
and treat all that follows as being an operand (not an option).
We can handle this by changing <tt>wc.clops</tt> a little.</p>

<pre class="prettyprint">
ARGS::
  DashFiles: {}: {file-list}: 
    [between="", allowMultiple="false", allowDash="true"]
  DashDash: {"--"}

FORMAT::
  (Option | Files)* (DashDash DashFiles*)?;
</pre>

<p>Also, add the following line at the end of your <tt>main</tt>
method:</p>

<pre class="prettyprint">
    for (File f : opt.getDashFiles()) checkFile(f);
</pre>

<p>Recompile and run.</p>

<pre class="cmdline">
ant
java -jar jars/wc.jar ARGUMENTS
</pre>

<p>As before, spend some time trying different <tt>ARGUMENTS</tt>.</p>

<p>Each option type, like <tt>file-list</tt>, has a number of
properties that customize its behavior, like <tt>between</tt>,
<tt>allowMultiple</tt>, and <tt>allowDash</tt>. The
default behavior for <tt>file-list</tt> is to recognize
command lines like <code class="cmdline">-f nameA,nameB</code> and like
<code class="cmdline">-f=nameA,nameB</code>. If the set of aliases
is left empty then it will recognize command lines
like <code class="cmdline">=nameA,nameB</code> or <code class="cmdline">&quot;&quot;
nameA,nameB</code>. In other words, it still expects <tt>=</tt>
or an argument delimiter between the empty prefix and the file
names. If we want command lines like <code class="cmdline">nameA,nameB</code> to
be recognized then we must say <tt>between=&quot;&quot;</tt>.
The second property, <tt>allowMultiple</tt>, defaults to
<tt>true</tt> and means that a comma&nbsp;(<tt>,</tt>) can be
used to separate multiple file names. But <tt>wc</tt> considers
the command line <code class="cmdline">x,y</code> as being one file name, not
two, so we set <tt>allowMultiple</tt> to <tt>false</tt> to get
this behavior. Finally, because it is by far the most common
behavior, the default is not to allow file names that begin with
a dash.</p>

<p>The other secret ingredient in getting the same behavior
as <tt>wc</tt> is the <i>format</i>. It says that a <tt>--</tt>
might appear (<tt>?</tt>) followed by any number (<tt>*</tt>)
of file names that may start with a dash.
</p>

<p>TODO: explain format string</p>

<p>TODO: explain other combinations of the presented properties,
perhaps plus splitter.</p>

<p>If you wonder if the zoo of properties is big enough to handle
all your needs then the answer is that underneath there is an even
more general mechanism, and most properties are just syntactic
sugar to make your life easier. Read on.</p>

<p>SCRAPS: If the set of aliases would contain
<tt>&quot;-f&quot;</tt> instead of being empty then command lines
like <code class="cmdline">-fnameA,nameB</code> would be recognized. The splitter
itself can be changed by using the property <tt>splitter</tt>.
You'd want to do this, for example, to read things like a
classpath. </p>


<h2>Regular expressions as aliases</h2>

<p>(TODO: Examples like -0... -9.)</p>

<h2>Custom options</h2>

<h2>A complex example</h2>

<p>(TODO: Partial <tt>clops</tt> file for <tt>tar</tt> to illustrate
the main points.)</p>


<hr/>
<p>
  <a href="http://sourceforge.net/projects/clops">
    <img src="http://sflogo.sourceforge.net/sflogo.php?group_id=257014&amp;type=13" width="120" height="30" alt="Get CLOPS at SourceForge.net. Fast, secure and Free Open Source software downloads" />
    </a>
  <a href="http://validator.w3.org/check?uri=referer"><img
     src="http://www.w3.org/Icons/valid-xhtml10-blue"
     alt="Valid XHTML 1.0 Strict" height="31" width="88" /></a>
</p>
</body>
</html>
<!--
vim: spell
-->
